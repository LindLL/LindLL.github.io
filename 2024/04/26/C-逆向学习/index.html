<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    

    
    
        
<link rel="stylesheet" href="/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/iconfont.css">


    
    

    
        <script data-ad-client="ca-" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    












          


    
    
    <title>
        
            C++逆向学习 | Hexo
        
    </title>
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/" class="mdui-typo-headline">Hexo</a>
    <a href="/" class="header-subtitle mdui-typo-headline"></a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">Overview</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">About</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-1">
        <div class="mdui-list">
            
                
                <a href="/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">Home</div>
                </a>
            
                
                <a href="/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">Tags</div>
                </a>
            
                
                <a href="/categories/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-folder"></i>
                    </div>
                    <div class="mdui-list-item-content">Categories</div>
                </a>
            
                
                <a href="/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">Archives</div>
                </a>
            
                
                <a href="/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">About</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">Night Mode</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-1">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/icons/tx.jpg"/>
                
            </div>
            <div class="sidebar-author-name">l0ck</div>
            <div class="sidebar-description">我本将心向明月</div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="mailto:2499086884@qq.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">Links</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                        <a target="_blank" rel="noopener" href="https://military-axe.github.io/" class="mdui-list-item mdui-ripple">
                            炮哥
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://h0pe-ay.github.io/" class="mdui-list-item mdui-ripple">
                            hope
                        </a>
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/">C++逆向学习</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      Posted on:&nbsp;2024-04-26
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      Edited on:&nbsp;2024-04-27
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      In:&nbsp;
    </span>
    
      <span>
        <span class="iconfont icon-eye"></span>
        Views:&nbsp;
        <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
      </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=C++逆向学习&url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/&pic=http://example.com/null&searchPic=false&style=simple" target="_blank" class="mdui-ripple">Share to Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=C++逆向学习&url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/&via=John Doe" target="_blank" class="mdui-ripple">Share to Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">Share to Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">Share to Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/&title=C++逆向学习" target="_blank" class="mdui-ripple">Share to LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=Hexo&title=C++逆向学习&summary=&pics=http://example.com/null&url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/" target="_blank" class="mdui-ripple">Share to QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=http://example.com/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/&text=C++逆向学习" target="_blank" class="mdui-ripple">Share to Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <h2 id="1-string分析"><a href="#1-string分析" class="headerlink" title="1.string分析"></a>1.string分析</h2><p>以下面的代码作为例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> str;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        str += <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;size : &quot;</span> &lt;&lt; str.size() &lt;&lt; <span class="string">&quot;   capacity : &quot;</span> &lt;&lt; str.capacity() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">size : 1   capacity : 15</span><br><span class="line">size : 2   capacity : 15</span><br><span class="line">size : 3   capacity : 15</span><br><span class="line">size : 4   capacity : 15</span><br><span class="line">size : 5   capacity : 15</span><br><span class="line">size : 6   capacity : 15</span><br><span class="line">size : 7   capacity : 15</span><br><span class="line">size : 8   capacity : 15</span><br><span class="line">size : 9   capacity : 15</span><br><span class="line">size : 10   capacity : 15</span><br><span class="line">size : 11   capacity : 15</span><br><span class="line">size : 12   capacity : 15</span><br><span class="line">size : 13   capacity : 15</span><br><span class="line">size : 14   capacity : 15</span><br><span class="line">size : 15   capacity : 15</span><br><span class="line">size : 16   capacity : 31</span><br><span class="line">size : 17   capacity : 31</span><br><span class="line">size : 18   capacity : 31</span><br><span class="line">size : 19   capacity : 31</span><br><span class="line">size : 20   capacity : 31</span><br><span class="line">size : 21   capacity : 31</span><br><span class="line">size : 22   capacity : 31</span><br><span class="line">size : 23   capacity : 31</span><br><span class="line">size : 24   capacity : 31</span><br><span class="line">size : 25   capacity : 31</span><br><span class="line">size : 26   capacity : 31</span><br><span class="line">size : 27   capacity : 31</span><br><span class="line">size : 28   capacity : 31</span><br><span class="line">size : 29   capacity : 31</span><br><span class="line">size : 30   capacity : 31</span><br><span class="line">size : 31   capacity : 31</span><br><span class="line">size : 32   capacity : 47</span><br><span class="line">size : 33   capacity : 47</span><br><span class="line">size : 34   capacity : 47</span><br><span class="line">size : 35   capacity : 47</span><br><span class="line">size : 36   capacity : 47</span><br><span class="line">size : 37   capacity : 47</span><br><span class="line">size : 38   capacity : 47</span><br><span class="line">size : 39   capacity : 47</span><br><span class="line">size : 40   capacity : 47</span><br><span class="line">size : 41   capacity : 47</span><br><span class="line">size : 42   capacity : 47</span><br><span class="line">size : 43   capacity : 47</span><br><span class="line">size : 44   capacity : 47</span><br><span class="line">size : 45   capacity : 47</span><br><span class="line">size : 46   capacity : 47</span><br><span class="line">size : 47   capacity : 47</span><br><span class="line">size : 48   capacity : 70</span><br><span class="line">size : 49   capacity : 70</span><br><span class="line">size : 50   capacity : 70</span><br><span class="line">size : 51   capacity : 70</span><br><span class="line">size : 52   capacity : 70</span><br><span class="line">size : 53   capacity : 70</span><br><span class="line">size : 54   capacity : 70</span><br><span class="line">size : 55   capacity : 70</span><br><span class="line">size : 56   capacity : 70</span><br><span class="line">size : 57   capacity : 70</span><br><span class="line">size : 58   capacity : 70</span><br><span class="line">size : 59   capacity : 70</span><br><span class="line">size : 60   capacity : 70</span><br><span class="line">size : 61   capacity : 70</span><br><span class="line">size : 62   capacity : 70</span><br><span class="line">size : 63   capacity : 70</span><br><span class="line">size : 64   capacity : 70</span><br><span class="line">size : 65   capacity : 70</span><br><span class="line">size : 66   capacity : 70</span><br><span class="line">size : 67   capacity : 70</span><br><span class="line">size : 68   capacity : 70</span><br><span class="line">size : 69   capacity : 70</span><br><span class="line">size : 70   capacity : 70</span><br><span class="line">size : 71   capacity : 105</span><br><span class="line">size : 72   capacity : 105</span><br><span class="line">size : 73   capacity : 105</span><br><span class="line">size : 74   capacity : 105</span><br><span class="line">size : 75   capacity : 105</span><br><span class="line">size : 76   capacity : 105</span><br><span class="line">size : 77   capacity : 105</span><br><span class="line">size : 78   capacity : 105</span><br><span class="line">size : 79   capacity : 105</span><br><span class="line">size : 80   capacity : 105</span><br><span class="line">size : 81   capacity : 105</span><br><span class="line">size : 82   capacity : 105</span><br><span class="line">size : 83   capacity : 105</span><br><span class="line">size : 84   capacity : 105</span><br><span class="line">size : 85   capacity : 105</span><br><span class="line">size : 86   capacity : 105</span><br><span class="line">size : 87   capacity : 105</span><br><span class="line">size : 88   capacity : 105</span><br><span class="line">size : 89   capacity : 105</span><br><span class="line">size : 90   capacity : 105</span><br><span class="line">size : 91   capacity : 105</span><br><span class="line">size : 92   capacity : 105</span><br><span class="line">size : 93   capacity : 105</span><br><span class="line">size : 94   capacity : 105</span><br><span class="line">size : 95   capacity : 105</span><br><span class="line">size : 96   capacity : 105</span><br><span class="line">size : 97   capacity : 105</span><br><span class="line">size : 98   capacity : 105</span><br><span class="line">size : 99   capacity : 105</span><br><span class="line">size : 100   capacity : 105</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>其实分析过Linux下的string机制的话，对string类是有一个大致的了解的，在str长度小于0x10的时候，string类是存储在栈上的，当长度超过0x10的时候，就会在堆上申请内存，将字符串存到堆上。</p>
<p>具体调试一下，初始化之后，str是存在栈上的</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261556119.png" alt="image-20240426120703205"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261556633.png" alt="image-20240426121111598"></p>
<p>红框处的值只是栈中残留的数据，不是string类真实的数据，string类开头的八字节指向红框处，当有了字符串之后，如下图所示</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261556380.png" alt="image-20240426121341987"></p>
<p>开头8字节指向字符串，第二个八字节为字符串的长度，字符串末尾以00结尾。</p>
<p>当字符串长度大于等于0x10之后，如下图所示</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261556991.png" alt="image-20240426121525346"></p>
<p>开头八字节指向堆了，这个堆的大小为0x30</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261556713.png" alt="image-20240426155612576"></p>
<p>观察输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size : 31   capacity : 31</span><br><span class="line">size : 32   capacity : 47</span><br></pre></td></tr></table></figure>

<p>当size为31时，加上末尾的00字节，此时的size为0x20，和capacity大小一致，结合glibc的堆块管理机制，可以推断第一次从堆中申请内存的大小为0x20，ptmalloc会返回0x30大小的堆块。</p>
<p>整个程序运行结束之后，堆的情况如下所示</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261612155.png" alt="image-20240426161205935"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261612045.png" alt="image-20240426161215280"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261612455.png" alt="image-20240426161223710"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261612417.png" alt="image-20240426161233355"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261612869.png" alt="image-20240426161242331"></p>
<p>0x30-&gt;0x50-&gt;0x90-&gt;0x100-&gt;0x1f0-&gt;0x3d0,可以看出，堆内存有效数据的扩容大致两倍的扩容的。如<code>malloc(0x20*2)=0x50,malloc(0x40*2)=0x90,malloc(0x80*2)=0x110,malloc(0xf0*2)=0x1f0,malloc(0x1e0*2)=0x3d0</code></p>
<p>不过在Windows下的扩容机制和Linux下稍有区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">size : 1   capacity : 15</span><br><span class="line">size : 2   capacity : 15</span><br><span class="line">size : 3   capacity : 15</span><br><span class="line">size : 4   capacity : 15</span><br><span class="line">size : 5   capacity : 15</span><br><span class="line">size : 6   capacity : 15</span><br><span class="line">size : 7   capacity : 15</span><br><span class="line">size : 8   capacity : 15</span><br><span class="line">size : 9   capacity : 15</span><br><span class="line">size : 10   capacity : 15</span><br><span class="line">size : 11   capacity : 15</span><br><span class="line">size : 12   capacity : 15</span><br><span class="line">size : 13   capacity : 15</span><br><span class="line">size : 14   capacity : 15</span><br><span class="line">size : 15   capacity : 15</span><br><span class="line">size : 16   capacity : 31</span><br><span class="line">size : 17   capacity : 31</span><br><span class="line">size : 18   capacity : 31</span><br><span class="line">size : 19   capacity : 31</span><br><span class="line">size : 20   capacity : 31</span><br><span class="line">size : 21   capacity : 31</span><br><span class="line">size : 22   capacity : 31</span><br><span class="line">size : 23   capacity : 31</span><br><span class="line">size : 24   capacity : 31</span><br><span class="line">size : 25   capacity : 31</span><br><span class="line">size : 26   capacity : 31</span><br><span class="line">size : 27   capacity : 31</span><br><span class="line">size : 28   capacity : 31</span><br><span class="line">size : 29   capacity : 31</span><br><span class="line">size : 30   capacity : 31</span><br><span class="line">size : 31   capacity : 31</span><br><span class="line">size : 32   capacity : 47</span><br><span class="line">size : 33   capacity : 47</span><br><span class="line">size : 34   capacity : 47</span><br><span class="line">size : 35   capacity : 47</span><br><span class="line">size : 36   capacity : 47</span><br><span class="line">size : 37   capacity : 47</span><br><span class="line">size : 38   capacity : 47</span><br><span class="line">size : 39   capacity : 47</span><br><span class="line">size : 40   capacity : 47</span><br><span class="line">size : 41   capacity : 47</span><br><span class="line">size : 42   capacity : 47</span><br><span class="line">size : 43   capacity : 47</span><br><span class="line">size : 44   capacity : 47</span><br><span class="line">size : 45   capacity : 47</span><br><span class="line">size : 46   capacity : 47</span><br><span class="line">size : 47   capacity : 47</span><br><span class="line">size : 48   capacity : 70</span><br><span class="line">size : 49   capacity : 70</span><br><span class="line">size : 50   capacity : 70</span><br><span class="line">size : 51   capacity : 70</span><br><span class="line">size : 52   capacity : 70</span><br><span class="line">size : 53   capacity : 70</span><br><span class="line">size : 54   capacity : 70</span><br><span class="line">size : 55   capacity : 70</span><br><span class="line">size : 56   capacity : 70</span><br><span class="line">size : 57   capacity : 70</span><br><span class="line">size : 58   capacity : 70</span><br><span class="line">size : 59   capacity : 70</span><br><span class="line">size : 60   capacity : 70</span><br><span class="line">size : 61   capacity : 70</span><br><span class="line">size : 62   capacity : 70</span><br><span class="line">size : 63   capacity : 70</span><br><span class="line">size : 64   capacity : 70</span><br><span class="line">size : 65   capacity : 70</span><br><span class="line">size : 66   capacity : 70</span><br><span class="line">size : 67   capacity : 70</span><br><span class="line">size : 68   capacity : 70</span><br><span class="line">size : 69   capacity : 70</span><br><span class="line">size : 70   capacity : 70</span><br><span class="line">size : 71   capacity : 105</span><br><span class="line">size : 72   capacity : 105</span><br><span class="line">size : 73   capacity : 105</span><br><span class="line">size : 74   capacity : 105</span><br><span class="line">size : 75   capacity : 105</span><br><span class="line">size : 76   capacity : 105</span><br><span class="line">size : 77   capacity : 105</span><br><span class="line">size : 78   capacity : 105</span><br><span class="line">size : 79   capacity : 105</span><br><span class="line">size : 80   capacity : 105</span><br><span class="line">size : 81   capacity : 105</span><br><span class="line">size : 82   capacity : 105</span><br><span class="line">size : 83   capacity : 105</span><br><span class="line">size : 84   capacity : 105</span><br><span class="line">size : 85   capacity : 105</span><br><span class="line">size : 86   capacity : 105</span><br><span class="line">size : 87   capacity : 105</span><br><span class="line">size : 88   capacity : 105</span><br><span class="line">size : 89   capacity : 105</span><br><span class="line">size : 90   capacity : 105</span><br><span class="line">size : 91   capacity : 105</span><br><span class="line">size : 92   capacity : 105</span><br><span class="line">size : 93   capacity : 105</span><br><span class="line">size : 94   capacity : 105</span><br><span class="line">size : 95   capacity : 105</span><br><span class="line">size : 96   capacity : 105</span><br><span class="line">size : 97   capacity : 105</span><br><span class="line">size : 98   capacity : 105</span><br><span class="line">size : 99   capacity : 105</span><br><span class="line">size : 100   capacity : 105</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>Windows下string类按照1.5倍扩容</p>
<p>string的扩容机制源码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">size_type _Grow_to(size_type _Count) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	size_type _Capacity = <span class="built_in">capacity</span>();</span><br><span class="line">	<span class="keyword">if</span> ( _Capacity &lt; <span class="number">32</span> ) &#123;</span><br><span class="line">		_Capacity = _Capacity + <span class="number">16</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">		_Capacity = <span class="built_in">max_size</span>() - _Capacity / <span class="number">2</span> &lt; _Capacity </span><br><span class="line">		? <span class="number">0</span> : _Capacity + _Capacity / <span class="number">2</span>;	<span class="comment">// try to grow by 50%</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (_Capacity &lt; _Count)</span><br><span class="line">		_Capacity = _Count;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> (_Capacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>基本而言就是每次增加上一次Capacity的1.5倍。</p>
<p>再使用如下程序进入IDA分析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    std::string str1;                      <span class="comment">// 默认构造函数</span></span><br><span class="line">    <span class="function">std::string <span class="title">str2</span><span class="params">(<span class="string">&quot;Hello, World!&quot;</span>)</span></span>;     <span class="comment">// 从C字符串构造</span></span><br><span class="line">    <span class="function">std::string <span class="title">str3</span><span class="params">(str2)</span></span>;                <span class="comment">// 拷贝构造函数</span></span><br><span class="line">    <span class="function">std::string <span class="title">str4</span><span class="params">(std::move(str2))</span></span>;     <span class="comment">// 移动构造函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋值运算符</span></span><br><span class="line">    str1 = str3;                           <span class="comment">// 复制赋值</span></span><br><span class="line">    str2 = <span class="string">&quot; Assigned String&quot;</span>;             <span class="comment">// 从C字符串赋值</span></span><br><span class="line">    str3 = std::<span class="built_in">move</span>(str1);                <span class="comment">// 移动赋值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串长度</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Length of str3: &quot;</span> &lt;&lt; str3.<span class="built_in">length</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问单个字符</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;First character of str3: &quot;</span> &lt;&lt; str3[<span class="number">0</span>] &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串连接</span></span><br><span class="line">    str3 += <span class="string">&quot; and more&quot;</span>;                   <span class="comment">// 字符串连接</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找子串</span></span><br><span class="line">    <span class="type">size_t</span> pos = str3.<span class="built_in">find</span>(<span class="string">&quot;and&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pos != std::string::npos) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Found &#x27;and&#x27; at position: &quot;</span> &lt;&lt; pos &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串比较</span></span><br><span class="line">    std::string str5 = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    std::string str6 = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (str5.<span class="built_in">compare</span>(str6) == <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;str5 and str6 are equal.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入输出流操作</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Enter a string: &quot;</span>;</span><br><span class="line">    std::<span class="built_in">getline</span>(std::cin, str1);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;You entered: &quot;</span> &lt;&lt; str1 &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源管理</span></span><br><span class="line">    <span class="comment">// std::string 的析构函数在这里自动调用</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IDA的反编译结果如下</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261956903.png" alt="image-20240426195602365"></p>
<p>直接创建空的string类使用<code>std::string::basic_string</code>，根据字符串来创建类会先初始化一个<code>std::allocator&lt;char&gt;::allocator()</code>的类，然后再根据字符串创建string类，根据string类来创建string也是使用<code>std::string::basic_string</code>，根据move来创建string也很清楚，先调用<code>std::move&lt;std::string &amp;&gt;</code>对string进行move，然后再使用<code>std::string::basic_string</code>来创建类。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404261958378.png" alt="image-20240426195811963"></p>
<p>string类的赋值使用的是<code>std::string::operator=(str1,str3)</code>，将str3赋值给str1，又或者将字符串赋值给str1.</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404262000623.png" alt="image-20240426200042599"></p>
<p>使用<code>std::string::operator[]</code>来取地址，第一个参数是string，第二个参数是要取的地址的索引。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404262010640.png" alt="image-20240426201051610"></p>
<p>使用<code>std::string::operator+=()</code>来完成字符串的拼接。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404262014426.png" alt="image-20240426201401493"></p>
<p>在返回之前调用析构函数，结束string类的生命周期。</p>
<h2 id="2-vector分析"><a href="#2-vector分析" class="headerlink" title="2.vector分析"></a>2.vector分析</h2><p>首先还是分析一下vector的扩容原则</p>
<p>例子如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; a;</span><br><span class="line">    <span class="type">int</span> num[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        a.<span class="built_in">push_back</span>(i);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;size : &quot;</span> &lt;&lt; i + <span class="number">1</span> &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; <span class="string">&quot;capacity : &quot;</span> &lt;&lt; a.<span class="built_in">capacity</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Linux下输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">size : 1        capacity : 1</span><br><span class="line">size : 2        capacity : 2</span><br><span class="line">size : 3        capacity : 4</span><br><span class="line">size : 4        capacity : 4</span><br><span class="line">size : 5        capacity : 8</span><br><span class="line">size : 6        capacity : 8</span><br><span class="line">size : 7        capacity : 8</span><br><span class="line">size : 8        capacity : 8</span><br><span class="line">size : 9        capacity : 16</span><br><span class="line">size : 10       capacity : 16</span><br><span class="line">size : 11       capacity : 16</span><br><span class="line">size : 12       capacity : 16</span><br><span class="line">size : 13       capacity : 16</span><br><span class="line">size : 14       capacity : 16</span><br><span class="line">size : 15       capacity : 16</span><br><span class="line">size : 16       capacity : 16</span><br><span class="line">size : 17       capacity : 32</span><br><span class="line">size : 18       capacity : 32</span><br><span class="line">size : 19       capacity : 32</span><br><span class="line">size : 20       capacity : 32</span><br><span class="line">size : 21       capacity : 32</span><br><span class="line">size : 22       capacity : 32</span><br><span class="line">size : 23       capacity : 32</span><br><span class="line">size : 24       capacity : 32</span><br><span class="line">size : 25       capacity : 32</span><br><span class="line">size : 26       capacity : 32</span><br><span class="line">size : 27       capacity : 32</span><br><span class="line">size : 28       capacity : 32</span><br><span class="line">size : 29       capacity : 32</span><br><span class="line">size : 30       capacity : 32</span><br><span class="line">size : 31       capacity : 32</span><br><span class="line">size : 32       capacity : 32</span><br><span class="line">size : 33       capacity : 64</span><br><span class="line">size : 34       capacity : 64</span><br><span class="line">size : 35       capacity : 64</span><br><span class="line">size : 36       capacity : 64</span><br><span class="line">size : 37       capacity : 64</span><br><span class="line">size : 38       capacity : 64</span><br><span class="line">size : 39       capacity : 64</span><br><span class="line">size : 40       capacity : 64</span><br><span class="line">size : 41       capacity : 64</span><br><span class="line">size : 42       capacity : 64</span><br><span class="line">size : 43       capacity : 64</span><br><span class="line">size : 44       capacity : 64</span><br><span class="line">size : 45       capacity : 64</span><br><span class="line">size : 46       capacity : 64</span><br><span class="line">size : 47       capacity : 64</span><br><span class="line">size : 48       capacity : 64</span><br></pre></td></tr></table></figure>

<p>很明显也是按照2倍大小扩容</p>
<p>在gdb中调试，查看堆的大小，也是符合2倍扩容的机制的。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404262053432.png" alt="image-20240426205329086"></p>
<p>在Windows下和Linux下的又稍有不同</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">size : 1        capacity : 1</span><br><span class="line">size : 2        capacity : 2</span><br><span class="line">size : 3        capacity : 3</span><br><span class="line">size : 4        capacity : 4</span><br><span class="line">size : 5        capacity : 6</span><br><span class="line">size : 6        capacity : 6</span><br><span class="line">size : 7        capacity : 9</span><br><span class="line">size : 8        capacity : 9</span><br><span class="line">size : 9        capacity : 9</span><br><span class="line">size : 10       capacity : 13</span><br><span class="line">size : 11       capacity : 13</span><br><span class="line">size : 12       capacity : 13</span><br><span class="line">size : 13       capacity : 13</span><br><span class="line">size : 14       capacity : 19</span><br><span class="line">size : 15       capacity : 19</span><br><span class="line">size : 16       capacity : 19</span><br><span class="line">size : 17       capacity : 19</span><br><span class="line">size : 18       capacity : 19</span><br><span class="line">size : 19       capacity : 19</span><br><span class="line">size : 20       capacity : 28</span><br><span class="line">size : 21       capacity : 28</span><br><span class="line">size : 22       capacity : 28</span><br><span class="line">size : 23       capacity : 28</span><br><span class="line">size : 24       capacity : 28</span><br><span class="line">size : 25       capacity : 28</span><br><span class="line">size : 26       capacity : 28</span><br><span class="line">size : 27       capacity : 28</span><br><span class="line">size : 28       capacity : 28</span><br><span class="line">size : 29       capacity : 42</span><br><span class="line">size : 30       capacity : 42</span><br><span class="line">size : 31       capacity : 42</span><br><span class="line">size : 32       capacity : 42</span><br><span class="line">size : 33       capacity : 42</span><br><span class="line">size : 34       capacity : 42</span><br><span class="line">size : 35       capacity : 42</span><br><span class="line">size : 36       capacity : 42</span><br><span class="line">size : 37       capacity : 42</span><br><span class="line">size : 38       capacity : 42</span><br><span class="line">size : 39       capacity : 42</span><br><span class="line">size : 40       capacity : 42</span><br><span class="line">size : 41       capacity : 42</span><br><span class="line">size : 42       capacity : 42</span><br><span class="line">size : 43       capacity : 63</span><br><span class="line">size : 44       capacity : 63</span><br><span class="line">size : 45       capacity : 63</span><br><span class="line">size : 46       capacity : 63</span><br><span class="line">size : 47       capacity : 63</span><br><span class="line">size : 48       capacity : 63</span><br><span class="line">size : 49       capacity : 63</span><br><span class="line">size : 50       capacity : 63</span><br><span class="line">size : 51       capacity : 63</span><br><span class="line">size : 52       capacity : 63</span><br><span class="line">size : 53       capacity : 63</span><br><span class="line">size : 54       capacity : 63</span><br></pre></td></tr></table></figure>

<p>除了一开始的容量变化是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">size : 1        capacity : 1</span><br><span class="line">size : 2        capacity : 2</span><br><span class="line">size : 3        capacity : 3</span><br><span class="line">size : 4        capacity : 4</span><br></pre></td></tr></table></figure>

<p>1，2，3，4不是1.5倍的增长率，后续的增长也是1.5倍的增长，源码为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">max_size</span>() - <span class="built_in">size</span>() &lt; _Count)</span><br><span class="line">    <span class="comment">//可以申请的最大容量也不够用，抛出异常_THROW(length_error, &quot;vector&lt;T&gt; too long&quot;);</span></span><br><span class="line">    _Xlen();</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (_Capacity &lt; <span class="built_in">size</span>() + _Count)&#123;<span class="comment">//空间不足，需要扩容   </span></span><br><span class="line">    _Capacity = <span class="built_in">max_size</span>() - _Capacity / <span class="number">2</span> &lt; _Capacity</span><br><span class="line">        ? <span class="number">0</span> : _Capacity + _Capacity / <span class="number">2</span>;    <span class="comment">// 尝试扩容1.5倍</span></span><br><span class="line">    <span class="keyword">if</span> (_Capacity &lt; <span class="built_in">size</span>() + _Count)<span class="comment">//扩容1.5倍后依然不够用，则容量等于当前数据个数加上新增数据个数</span></span><br><span class="line">        _Capacity = <span class="built_in">size</span>() + _Count;</span><br><span class="line">    pointer _Newvec = <span class="keyword">this</span>-&gt;_Alval.<span class="built_in">allocate</span>(_Capacity);<span class="comment">//申请新空间</span></span><br><span class="line">    pointer _Ptr = _Newvec;</span><br><span class="line">    _TRY_BEGIN</span><br><span class="line">        _Ptr = _Umove(_Myfirst, _VEC_ITER_BASE(_Where),</span><br><span class="line">            _Newvec);   <span class="comment">//move原先的数据</span></span><br><span class="line">    _Ptr = _Ucopy(_First, _Last, _Ptr); <span class="comment">//copy新增的数据到新内存之后</span></span><br><span class="line">    _Umove(_VEC_ITER_BASE(_Where), _Mylast, _Ptr);  </span><br><span class="line">    _CATCH_ALL</span><br><span class="line">        _Destroy(_Newvec, _Ptr);</span><br><span class="line">    <span class="keyword">this</span>-&gt;_Alval.<span class="built_in">deallocate</span>(_Newvec, _Capacity);<span class="comment">//释放原来申请的内存</span></span><br><span class="line">    _RERAISE;</span><br><span class="line">    _CATCH_END</span><br></pre></td></tr></table></figure>

<p>首先会尝试扩容1.5倍，如果扩容1.5倍之后依然无法满足size，就会将容量设置为当前size+新增数据的个数，然后再分配内存。</p>
<p>下面再用一个例子给出IDA分析视角</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span> <span class="comment">// 用于 std::transform, std::accumulate, std::fill, std::find</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span>   <span class="comment">// 用于 std::accumulate</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构造函数</span></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">vec1</span><span class="params">(<span class="number">10</span>)</span></span>; <span class="comment">// 构造一个大小为10的向量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::transform 填充向量</span></span><br><span class="line">    std::<span class="built_in">transform</span>(vec1.<span class="built_in">begin</span>(), vec1.<span class="built_in">end</span>(), vec1.<span class="built_in">begin</span>(), [](<span class="type">int</span> i) &#123; <span class="keyword">return</span> i * i; &#125;);</span><br><span class="line">    <span class="comment">// 现在 vec1 包含了 0^2, 1^2, 2^2, ..., 9^2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出变换后的向量</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num : vec1) &#123;</span><br><span class="line">        std::cout &lt;&lt; num &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::accumulate 计算向量的总和</span></span><br><span class="line">    <span class="type">int</span> sum = std::<span class="built_in">accumulate</span>(vec1.<span class="built_in">begin</span>(), vec1.<span class="built_in">end</span>(), <span class="number">0</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Sum of squares: &quot;</span> &lt;&lt; sum &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::accumulate 计算向量的乘积</span></span><br><span class="line">    <span class="type">int</span> product = std::<span class="built_in">accumulate</span>(vec1.<span class="built_in">begin</span>(), vec1.<span class="built_in">end</span>(), <span class="number">1</span>, std::<span class="built_in">multiplies</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Product of squares: &quot;</span> &lt;&lt; product &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::transform 和 std::accumulate 结合计算向量的平均值</span></span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">vec2</span><span class="params">(<span class="number">10</span>, <span class="number">1</span>)</span></span>; <span class="comment">// 创建一个大小为10的向量，所有元素都是1</span></span><br><span class="line">    std::<span class="built_in">transform</span>(vec2.<span class="built_in">begin</span>(), vec2.<span class="built_in">end</span>(), vec2.<span class="built_in">begin</span>(), [](<span class="type">int</span> i) &#123; <span class="keyword">return</span> i + <span class="number">1</span>; &#125;);</span><br><span class="line">    <span class="comment">// 现在 vec2 包含了 2, 3, 4, ..., 11</span></span><br><span class="line">    <span class="type">double</span> average = std::<span class="built_in">accumulate</span>(vec2.<span class="built_in">begin</span>(), vec2.<span class="built_in">end</span>(), <span class="number">0.0</span>) / vec2.<span class="built_in">size</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Average of transformed vec2: &quot;</span> &lt;&lt; average &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::fill 将 vec1 的所有元素替换为 -1</span></span><br><span class="line">    std::<span class="built_in">fill</span>(vec1.<span class="built_in">begin</span>(), vec1.<span class="built_in">end</span>(), <span class="number">-1</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After filling with -1: &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> num : vec1) &#123;</span><br><span class="line">        std::cout &lt;&lt; num &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 std::find 查找 vec2 中的第一个元素 5</span></span><br><span class="line">    <span class="keyword">auto</span> it = std::<span class="built_in">find</span>(vec2.<span class="built_in">begin</span>(), vec2.<span class="built_in">end</span>(), <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != vec2.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Found 5 at position: &quot;</span> &lt;&lt; std::<span class="built_in">distance</span>(vec2.<span class="built_in">begin</span>(), it) &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;5 not found in vec2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 emplace_back 添加一个元素到 vec1</span></span><br><span class="line">    vec1.<span class="built_in">emplace_back</span>(<span class="number">42</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After emplace_back(42), vec1 back: &quot;</span> &lt;&lt; vec1.<span class="built_in">back</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 resize 改变 vec2 的大小</span></span><br><span class="line">    vec2.<span class="built_in">resize</span>(<span class="number">5</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After resize(5), vec2 size: &quot;</span> &lt;&lt; vec2.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 reserve 为 vec1 预留空间</span></span><br><span class="line">    vec1.<span class="built_in">reserve</span>(<span class="number">20</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After reserve(20), vec1 capacity: &quot;</span> &lt;&lt; vec1.<span class="built_in">capacity</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 shrink_to_fit 释放不需要的内存</span></span><br><span class="line">    vec1.<span class="built_in">shrink_to_fit</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;After shrink_to_fit(), vec1 capacity: &quot;</span> &lt;&lt; vec1.<span class="built_in">capacity</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 资源管理</span></span><br><span class="line">    <span class="comment">// std::vector 的析构函数在这里自动调用</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IDA视角如下</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271039052.png" alt="image-20240427103916269"></p>
<p>vector需要先初始化一个allocator，然后传入<code>std::vector&lt;int&gt;::vector(vec1, 10LL, v57)</code>用于分配内存空间。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271046646.png" alt="image-20240427104613687"></p>
<p>这一段对应着<code>std::transform(vec1.begin(), vec1.end(), vec1.begin(), [](int i) &#123; return i * i; &#125;);</code>这行代码，具体实现如下</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271050563.png" alt="image-20240427105007728"></p>
<p>再往下看</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271055863.png" alt="image-20240427105537782"></p>
<p>这一段也挺好识别的，因为没有去符号表，c++的各种接口都很明显。</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20240427105852206.png" alt="image-20240427105852206"></p>
<p>后续部分也基本类似，如果不去掉符号表的话其实IDA的伪代码已经挺好看了。</p>
<h2 id="3-类"><a href="#3-类" class="headerlink" title="3.类"></a>3.类</h2><p>以如下代码为例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">base</span> &#123;<span class="comment">//基类</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> a;<span class="comment">//成员变量</span></span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="built_in">base</span>() &#123;<span class="comment">//构造函数</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;b = <span class="number">2.3</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;base constructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;<span class="comment">//成员函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d  %lf\n&quot;</span>, a, b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func1</span><span class="params">()</span> </span>&#123;<span class="comment">//虚函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;base v_func1()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func2</span><span class="params">()</span> </span>&#123;<span class="comment">//虚函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;base v_func2()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">base</span>() &#123;<span class="comment">//析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;base destructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">derived</span> :<span class="keyword">public</span> base &#123;<span class="comment">//派生类</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">derived</span>() &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;derived constructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func</span><span class="params">()</span> </span>&#123;<span class="comment">//虚函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;derived v_func()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">derived</span>() &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;derived destructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    base a;</span><br><span class="line">    a.<span class="built_in">func</span>();</span><br><span class="line">    a.<span class="built_in">v_func1</span>();</span><br><span class="line"></span><br><span class="line">    base* b = (base*)<span class="keyword">new</span> <span class="built_in">derived</span>();</span><br><span class="line">    b-&gt;<span class="built_in">func</span>();</span><br><span class="line">    b-&gt;<span class="built_in">v_func2</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中有基类，派生类，类中有成员变量，成员函数，虚函数。</p>
<p>直接看到IDA视角</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271124651.png" alt="image-20240427112414536"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271142112.png" alt="image-20240427114159395"></p>
<p>可以看到，base类的每一个函数都传入了this指针，this指针为类函数的第一个参数，通过rdi传参。</p>
<p>看到构造函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271144136.png" alt="image-20240427114400491"></p>
<p>this的首字段并不是成员变量，而是一个地址，这个地址实际上就是虚函数表</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271147402.png" alt="image-20240427114739212"></p>
<p>这个地址称为虚表指针，是由编译器在类中添加的隐藏成员。</p>
<p>在虚表地址上方还有一个typeinfo，<code>typeinfo</code>是编译器生成的特殊类型信息，包括对象继承关系、对象本身的描述等。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271324137.png" alt="image-20240427132430075"></p>
<p>在析构函数中，同样对this的首字段进行了赋值，<strong>因为编译器无法预知这个子类以后是否会被其他类继承，如果被继承，原来的子类就成了父类，在执行析构函数时会先执行当前对象的析构函数，然后向祖父类的方向按继承线路逐层调用各类析构函数，当前对象的析构函数开始执行时，其虚表也是当前对象的，所以执行到父类的析构函数时，虚表必须改写为父类的虚表。编译器产生的类实现代码，必须能够适应将来不可预知的对象关系，故在每个对象的析构函数内，要加入自己虚表的代码。</strong></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271331145.png" alt="image-20240427133134294"></p>
<p>v3是derived类实例的地址</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271333737.png" alt="image-20240427133258457"></p>
<p>在构造函数中初始化了虚表指针</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271333019.png" alt="image-20240427133356169"></p>
<p>*v3+8就是func2的地址。</p>
<p>再看一下类的继承，derived类的父类是base类，如上图，在derived类的构造函数中，会先执行base类的构造函数，再进行derived类的初始化，derived类的虚表函数中有三个函数指针，前两个都是base类的，第三个是自己的。我们将derived类自己的虚函数注释掉，再看看它的虚表会有什么变化。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">derived</span> :<span class="keyword">public</span> base &#123;<span class="comment">//派生类</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">derived</span>() &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;derived constructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// virtual void v_func() &#123;//虚函数</span></span><br><span class="line">    <span class="comment">//     printf(&quot;derived v_func()&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    ~<span class="built_in">derived</span>() &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;derived destructor\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271341007.png" alt="image-20240427134139026"></p>
<p>我们看到，即使derived没有自己的虚函数，它自己也有一套独立的虚表，内容和base类的一样。</p>
<p><strong>再看到全局变量类，并且有虚函数的情况</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Global</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Global</span>()</span><br><span class="line">    &#123; <span class="comment">// 无参构造函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Global\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Global</span>(<span class="type">int</span> n)</span><br><span class="line">    &#123; <span class="comment">// 有参构造函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Global(int n) %d\n&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Global</span>(<span class="type">const</span> <span class="type">char</span> *s)</span><br><span class="line">    &#123; <span class="comment">// 有参构造函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Global(char *s) %s\n&quot;</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Global</span>()</span><br><span class="line">    &#123; <span class="comment">// 虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;~Global()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Object Addr: 0x%p&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Global g_global1;</span><br><span class="line"><span class="function">Global <span class="title">g_global2</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line"><span class="function">Global <span class="title">g_global3</span><span class="params">(<span class="string">&quot;hello C++&quot;</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_global1.<span class="built_in">show</span>();</span><br><span class="line">    g_global2.<span class="built_in">show</span>();</span><br><span class="line">    g_global3.<span class="built_in">show</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虚表应该在类的构造函数中初始化，但是在本例中，类为全局变量，不在main函数中声明，那么此时虚表应该在何时初始化呢？</p>
<p>在执行main函数之前会调用init_array中的函数，全局类的初始化函数就放在init_array中，称之为构造代理函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271412160.png" alt="image-20240427141158911"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271414118.png" alt="image-20240427141436812"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271414635.png" alt="image-20240427141445629"></p>
<p>最终在<code>__static_initialization_and_destruction_0</code>中进行初始化，<code>__cxa_atexit</code>函数将在main函数结束时调用，用于析构全局类。</p>
<p><strong>多重继承</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sofa</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Sofa</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        color = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Sofa</span>()</span><br><span class="line">    &#123; <span class="comment">// 沙发类虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;virtual ~Sofa()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getColor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 获取沙发颜色</span></span><br><span class="line">        <span class="keyword">return</span> color;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sitDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 沙发可以坐下休息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sit down and rest your legs\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> color; <span class="comment">// 沙发类成员变量</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 定义床类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bed</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Bed</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        length = <span class="number">4</span>;</span><br><span class="line">        width = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Bed</span>()</span><br><span class="line">    &#123; <span class="comment">// 床类虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;virtual ~Bed()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 获取床面积</span></span><br><span class="line">        <span class="keyword">return</span> length * width;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 床可以用来睡觉</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;go to sleep\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> length; <span class="comment">// 床类成员变量</span></span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 子类沙发床定义，派生自Sofa类和Bed类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SofaBed</span> : <span class="keyword">public</span> Sofa, <span class="keyword">public</span> Bed</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SofaBed</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        height = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">SofaBed</span>()</span><br><span class="line">    &#123; <span class="comment">// 沙发床类的虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;virtual ~SofaBed()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sitDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 沙发可以坐下休息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sit down on the sofa bed\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 床可以用来睡觉</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;go to sleep on the sofa bed\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getHeight</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SofaBed sofabed;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义了一个sofa类和一个bed类，sofabed类继承自这两个类。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271435316.png" alt="image-20240427143508629"></p>
<p>sofabed类的构造函数会依次执行sofa和bed的构造函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271456307.png" alt="image-20240427145616527"></p>
<p>这两个分别是sofa和bed的虚表指针，当sofa和bed构造完成之后就会执行sofabed的构造函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271500957.png" alt="image-20240427150002214"></p>
<p>sofabed会将两个虚表指针修改为自身的虚表指针。可见，在多重继承中，子类虚表指针的个数取决于继承的父类的个数，有几个父类便会出现几个虚表指针。</p>
<p><strong>再看有纯虚函数的类，也就是抽象类</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AbstractBase</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">AbstractBase</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;AbstractBase()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">show</span><span class="params">()</span> </span>= <span class="number">0</span>; <span class="comment">// 定义纯虚函数</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VirtualChild</span> : <span class="keyword">public</span> AbstractBase</span><br><span class="line">&#123; <span class="comment">// 定义继承抽象类的子类</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 实现纯虚函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;抽象类分析\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VirtualChild obj;</span><br><span class="line">    obj.<span class="built_in">show</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271556041.png" alt="image-20240427155637587"></p>
<p>抽象类也有虚表，只不过虚表函数什么都没干。</p>
<p><strong>虚继承</strong></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271603512.png" alt="cpp"></p>
<p>B继承于A,C继承于A，D继承于B和C</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 定义家具类，虚基类，等同于类A</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Furniture</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Furniture</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Furniture::Furniture()\n&quot;</span>);</span><br><span class="line">        price = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Furniture</span>()</span><br><span class="line">    &#123; <span class="comment">// 家具类的虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Furniture::~Furniture()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getPrice</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 获取家具价格</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Furniture::getPrice()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> price; <span class="comment">// 家具类的成员变量</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 定义沙发类，继承自类Furniture，等同于类B</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sofa</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> Furniture</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Sofa</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sofa::Sofa()\n&quot;</span>);</span><br><span class="line">        price = <span class="number">1</span>;</span><br><span class="line">        color = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Sofa</span>()</span><br><span class="line">    &#123; <span class="comment">// 沙发类虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sofa::~Sofa()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getColor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 获取沙发颜色</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sofa::getColor()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> color;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sitDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 沙发可以坐下休息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sofa::sitDown()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> color; <span class="comment">// 沙发类成员变量</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 定义床类，继承自类Furniture，等同于类C</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bed</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> Furniture</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Bed</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bed::Bed()\n&quot;</span>);</span><br><span class="line">        price = <span class="number">3</span>;</span><br><span class="line">        length = <span class="number">4</span>;</span><br><span class="line">        width = <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Bed</span>()</span><br><span class="line">    &#123; <span class="comment">// 床类的虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bed::~Bed()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getArea</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 获取床面积</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bed::getArea()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> length * width;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 床可以用来睡觉</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Bed::sleep()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> length; <span class="comment">// 床类成员变量</span></span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 子类沙发床的定义，派生自类Sofa和类Bed，等同于类D</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SofaBed</span> : <span class="keyword">public</span> Sofa, <span class="keyword">public</span> Bed</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SofaBed</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::SofaBed()\n&quot;</span>);</span><br><span class="line">        height = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">SofaBed</span>()</span><br><span class="line">    &#123; <span class="comment">// 沙发床类的虚析构函数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::~SofaBed()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sitDown</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 沙发可以坐下休息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::sitDown()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123; <span class="comment">// 床可以用来睡觉</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::sleep()\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">getHeight</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::getHeight()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> height; <span class="comment">// 沙发类的成员变量</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SofaBed sofabed;</span><br><span class="line">    Furniture *p1 = &amp;sofabed; <span class="comment">// 转换成虚基类指针</span></span><br><span class="line">    Sofa *p2 = &amp;sofabed;      <span class="comment">// 转换成父类指针</span></span><br><span class="line">    Bed *p3 = &amp;sofabed;       <span class="comment">// 转换成父类指针</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p %p %p\n&quot;</span>, p1, p2, p3);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到sofabed的构造函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271608484.png" alt="image-20240427160816242"></p>
<p>furniture传入的参数是<code>*this + 40</code>，说明furniture这个基类位于sofabed类的最底部，sofa类位于最上方，bed类位于sofa类下方。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202404271624223.png" alt="image-20240427162359350"></p>
<p>开头0x10字节为sofa类，紧跟着的0x18字节为bed类，后面的6是sofabed类的height，之后的就是furniture类了。</p>
<p>虚基类继承只会初始化一次虚基类。</p>
<p>参考连接：</p>
<p>1.<a target="_blank" rel="noopener" href="https://wsxk.github.io/c++reverse/">c++ 机制逆向分析 – wsxk’s blog – 小菜鸡</a></p>
<p>2.<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5242?time__1311=n4+xnD07itGQ=D54AKDsA3xCuhDcDu0GD4oD&alichlgref=https://xz.aliyun.com/u/15779">C++逆向学习(四) 类 - 先知社区 (aliyun.com)</a></p>

  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="iconfont icon-heartbeat" style="font-size:24px;"></i> The End --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/2024/01/15/linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/">
        <span>linux高性能服务器开发</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/2024/04/26/C-%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/" id="toc-header" class="mdui-ripple">Table of Contents</a>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-string%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">1.string分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-vector%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">2.vector分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%B1%BB"><span class="toc-number">3.</span> <span class="toc-text">3.类</span></a></li></ol>
      </li>
    </ul>
  </div>



    <div id="comment" class="mdui-card mdui-p-a-2 mdui-m-b-5">
      <div class="mdui-tab" mdui-tab>
        
          <a href="#comment-tab0" class="mdui-ripple">gitalk</a>
        
          <a href="#comment-tab1" class="mdui-ripple">livere</a>
        
      </div>
      
        <div id="comment-tab0" class="mdui-p-a-2">
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id:  md5(location.pathname) ,
    distractionFreeMode: 'true',
  });
  gitalk.render('gitalk-container');
</script>
        </div>
      
        <div id="comment-tab1" class="mdui-p-a-2">
          <div id="lv-container" data-id="city" data-uid="">
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];
      if (typeof LivereTower === 'function') { return; }
      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;
      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <noscript>Please enable JavaScript to view the comments powered by LiveRe.</noscript>
</div>
        </div>
      
    </div>

  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
        <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank"></a>
      
      <span>
        &copy; 2015 - 2024 
        
          <span style="color:#d9333f" class="iconfont icon-heart"></span>
        
        John Doe
      </span>
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span>Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span>Theme: <a href="https://github.com/kb1000fx/Meadow" rel="noopener" target="_blank">Meadow</a></span>
        </div>
      
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span id="busuanzi_container_site_uv" style="display: none;"> <span class="iconfont icon-user"></span>Total Visitors <span id="busuanzi_value_site_uv"></span></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span id="busuanzi_container_site_pv" style="display: none;"> <span class="iconfont icon-eye"></span>Total Views <span id="busuanzi_value_site_pv"></span></span>
        </div>
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  

    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/js/mdui.min.v1.0.0.js"></script>




<script src="/js/meadow.js"></script>

</body>
</html >