<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Regular.woff2" as="font">
        <link rel="preload" crossorigin="crossorigin" href="/fonts/roboto/Roboto-Bold.woff2" as="font">
    
    
    
        <link rel="shortcut icon" href="/icons/favicon.ico">
    

    
    
        
<link rel="stylesheet" href="/css/mdui.min.v1.0.0.css">

    
    
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/iconfont.css">


    
    

    
        <script data-ad-client="ca-" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    












          


    
    
    <title>
        
            TS3480折腾记录 | Hexo
        
    </title>
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-primary-teal mdui-theme-accent-blue">
  
  <header class="mdui-appbar mdui-appbar-fixed">
  <div id="toolbar" class="mdui-toolbar mdui-color-theme">
    <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="iconfont icon-menu"></i></button>
    <a href="/" class="mdui-typo-headline">Hexo</a>
    <a href="/" class="header-subtitle mdui-typo-headline"></a>
    <div class="mdui-toolbar-spacer"></div>
    <button class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: 'search'}"><i class="iconfont icon-search"></i></button>
  </div>
</header>

<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字" onfocus="listenSearchFunc()">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>

  <aside id="sidebar" class="mdui-drawer">
    <div class="mdui-tab" mdui-tab>
        <a href="#sidebar-tab1" id="sidebartab" class="mdui-ripple mdui-tab-active">Overview</a>
        <a href="#sidebar-tab2" id="sidebartab" class="mdui-ripple">About</a>
    </div>

    
    <div id="sidebar-tab1" class="mdui-p-a-1">
        <div class="mdui-list">
            
                
                <a href="/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-home"></i>
                    </div>
                    <div class="mdui-list-item-content">Home</div>
                </a>
            
                
                <a href="/tags/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-bookmark"></i>
                    </div>
                    <div class="mdui-list-item-content">Tags</div>
                </a>
            
                
                <a href="/categories/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-folder"></i>
                    </div>
                    <div class="mdui-list-item-content">Categories</div>
                </a>
            
                
                <a href="/archives/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-archive"></i>
                    </div>
                    <div class="mdui-list-item-content">Archives</div>
                </a>
            
                
                <a href="/about/" class="mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-user"></i>
                    </div>
                    <div class="mdui-list-item-content">About</div>
                </a>
            
            <div class="mdui-list-item mdui-ripple">
                <div class="mdui-list-item-icon">
                    <i class="iconfont icon-moon"></i>
                </div>
                <div class="mdui-list-item-content">Night Mode</div>
                <label class="mdui-switch" id="darkmode">
                  <input type="checkbox" id="nightmode_switch"/>
                  <i class="mdui-switch-icon"></i>
                </label>
            </div>           
        </div>
    </div>

    
    <div id="sidebar-tab2" class="mdui-p-a-1">
        <div class="sidebar-overview">
            <div class="sidebar-avatar">
                
                    <img src="/icons/tx.jpg"/>
                
            </div>
            <div class="sidebar-author-name">l0ck</div>
            <div class="sidebar-description">我本将心向明月</div>
        </div>
        <div class="sidebar-links">
            
                
                <div class="mdui-chip">
                    <span class="mdui-chip-icon"><i class="iconfont icon-mail"></i></span>
                    <a href="mailto:2499086884@qq.com" class="mdui-chip-title">E-Mail</a>
                </div>
            
        </div>
        <ul class="mdui-list" mdui-collapse="{accordion: true}">
            <li class="mdui-collapse-item">
                <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
                    <div class="mdui-list-item-icon">
                        <i class="iconfont icon-link"></i>
                    </div>
                    <div class="mdui-list-item-content">Links</div>
                    <div class="mdui-collapse-item-arrow">
                        <i class="mdui-list-item-icon iconfont icon-angle-down"></i>
                    </div>
                </div>
                <ul id="linksList" class="mdui-collapse-item-body mdui-list mdui-list-dense">
                    
                        <a target="_blank" rel="noopener" href="https://military-axe.github.io/" class="mdui-list-item mdui-ripple">
                            炮哥
                        </a>
                    
                        <a target="_blank" rel="noopener" href="https://h0pe-ay.github.io/" class="mdui-list-item mdui-ripple">
                            hope
                        </a>
                    
                </ul>
            </li>
        </ul>
    </div>

    <div class="mdui-divider"></div>
    
    
</aside>
  
  <main id="main-contain" class="mdui-container mdui-m-t-5">
    <article id="article" class="mdui-card mdui-p-b-2 mdui-m-b-5">
  <header class="mdui-card-media">
    
    
      <div class="post-header"> 
  <a class="post-header-title" href="/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/">TS3480折腾记录</a>
  <div class="post-header-meta">
    <span>
      <span class="iconfont icon-calendar"></span>
      Posted on:&nbsp;2024-01-09
    </span>
    <span>
      <span class="iconfont icon-calendar-check"></span>
      Edited on:&nbsp;2024-03-14
    </span>
    <span>
      <span class="iconfont icon-folder"></span>
      In:&nbsp;
    </span>
    
      <span>
        <span class="iconfont icon-eye"></span>
        Views:&nbsp;
        <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
      </span>
    
  </div>
</div>   
    



    
    
    <div class="mdui-card-menu">
    
      <button class="mdui-btn mdui-btn-icon mdui-text-color-teal" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="iconfont icon-share"></i></button>
      <ul class="mdui-menu" id="share_menu">
        <li class="mdui-menu-item">
          <a href="http://service.weibo.com/share/share.php?appkey=&title=TS3480折腾记录&url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/&pic=http://example.com/null&searchPic=false&style=simple" target="_blank" class="mdui-ripple">Share to Weibo</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://twitter.com/intent/tweet?text=TS3480折腾记录&url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/&via=John Doe" target="_blank" class="mdui-ripple">Share to Twitter</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.facebook.com/sharer/sharer.php?u=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" target="_blank" class="mdui-ripple">Share to Facebook</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://plus.google.com/share?url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" target="_blank" class="mdui-ripple">Share to Google+</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/&title=TS3480折腾记录" target="_blank" class="mdui-ripple">Share to LinkedIn</a>
        </li>
        <li class="mdui-menu-item">
          <a href="http://connect.qq.com/widget/shareqq/index.html?site=Hexo&title=TS3480折腾记录&summary=&pics=http://example.com/null&url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" target="_blank" class="mdui-ripple">Share to QQ</a>
        </li>
        <li class="mdui-menu-item">
          <a href="https://telegram.me/share/url?url=http://example.com/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/&text=TS3480折腾记录" target="_blank" class="mdui-ripple">Share to Telegram</a>
        </li>
      </ul>
    
  </div>
  </header>
  
  
  
  
  
  <div class="mdui-card-content mdui-typo mdui-p-x-4">
    <p>端口扫描，TCP端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE SERVICE    VERSION</span><br><span class="line">80/tcp   open  http</span><br><span class="line">443/tcp  open  ssl/https?</span><br><span class="line">515/tcp  open  printer</span><br><span class="line">631/tcp  open  ssl/ipp</span><br><span class="line">9100/tcp open  jetdirect?</span><br></pre></td></tr></table></figure>

<p>UDP端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PORT      STATE         SERVICE      VERSION</span><br><span class="line">67/udp    open|filtered dhcps</span><br><span class="line">68/udp    open|filtered dhcpc</span><br><span class="line">161/udp   open          snmp         SNMPv1 server; CANON Inc. SNMPv3 server (public)</span><br><span class="line">1900/udp  open|filtered upnp</span><br><span class="line">1901/udp  open|filtered fjicl-tep-a</span><br><span class="line">3702/udp  open|filtered ws-discovery</span><br><span class="line">5353/udp  open          mdns         DNS-based service discovery</span><br><span class="line">5355/udp  open|filtered llmnr</span><br><span class="line">54721/udp open|filtered unknown</span><br><span class="line">54726/udp open|filtered unknown</span><br></pre></td></tr></table></figure>

<p>官网没有固件，打印机走的https流量，抓不到东西，打印机设置了http代理之后抓到了这么个流量</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230505150025159.png" alt="image-20230505150025159"></p>
<p>但是不是固件，只有几百字节，而且没有可见字符</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230505172135971.png" alt="image-20230505172135971"></p>
<p>个人猜测这是一个加密之后的存有固件下载链接的文件，打印机将其下载之后进行解密得到固件更新地址。</p>
<p>还是直接拆设备提固件吧，经过一顿折腾，拆下来了pcb板</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092035662.png" alt="image-20230506144657983"></p>
<p>flash上的丝印为<code>winbond25Q128JVSQ</code>，一款winbond公司的16MB大小的flash</p>
<p>热风枪吹下来用编程器进行提取，吹下来的时候不小心力气用大了一点把焊盘给拉起来了，不知道焊回去了还能不能用</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230506164656961.png" alt="image-20230506164656961"></p>
<p>可惜的是，从flash上提取下来的固件居然也是加密状态，只有极少数可见字符串</p>
<p>binwalk -E走一波</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230506164840390.png" alt="image-20230506164840390"></p>
<p>看那几道几乎水平的熵值，就知道这肯定有加密或这被压缩过了。</p>
<p>加密的固件必不可能运行，所以在被运行之前肯定有一个解密的过程。解密的过程通常由bootloader来完成，我们知道嵌入式系统在上电之后会先运行bootload初始化硬件并加载内核，所以bootloader肯定是不能处于加密状态的，bootloader都加密了那整个固件就没有一个可以运行的部分了。</p>
<p>对于有些设备，bootloader和固件是存在一个flash中的，而有些设备则是一个8M或者其他大小的flash用于存储flash，另一个NAND flash或者emmc用于存放固件。对于ts3480这款打印机而言只有一个16MB的flash，其bootloader和固件是存在一起的。</p>
<p>根据前面的分析，固件虽然处于加密状态，但肯定是有一小段未加密的数据的，这些数据我们要重点关注，其中应该会存在解密固件的关键。</p>
<p>binwalk -A 走一波，看看哪里能够识别成指令</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230506174309488.png" alt="image-20230506174309488"></p>
<p>最开始的指令是<code>0x2E00FC</code>处，用010打开</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507162154433.png" alt="image-20230507162154433"></p>
<p>实际上，从0x2E0000开始才是有指令的位置，IDA打开并在0x2E0000处进行反编译</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507162507898.png" alt="image-20230507162507898"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507162745498.png" alt="image-20230507162745498"></p>
<p>注意到<code>0xF02E0190</code>这个值，我们跳转到0x2E0190处看看</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507162841120.png" alt="image-20230507162841120"></p>
<p>很巧，0x2E0190处正好是一段数据，所以猜测flash的加载地址为0xf0000000,重新设置flash的加载地址</p>
<p>继续往下看</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507173338640.png" alt="image-20230507173338640"></p>
<p>将从0xF02E058C开始的数据拷贝到0x400000处，拷贝长度为0x36d4</p>
<p>在这里可以使用如下命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=ts3480.BIN of=first_ram_cpoy.bin bs=1 count=14036 skip=3016076</span><br></pre></td></tr></table></figure>

<p>将0xF02E058C处的数据，也就是固件偏移为0x2E058C处、长度为0x36d4的数据提取出来</p>
<p>然后新建一个段</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507194211122.png" alt="image-20230507194211122"></p>
<p>再使用IDA的附加二进制文件的功能</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092036123.png" alt="image-20230507194251566"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507194329773.png" alt="image-20230507194329773"></p>
<p>将这一段数据添加到我们刚刚创建好的段中，这样一来就模拟了前面的数据拷贝的操作。</p>
<p>再看到sub_F02E04F0函数，这个函数又会执行0x400312处的函数，而0x400000-0x4036d4处的数据已经被设置为了0xF02E058C处的数据</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507193612002.png" alt="image-20230507193612002"></p>
<p>而sub_400312如下所示</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507193957812.png" alt="image-20230507193957812"></p>
<p>跟进到sub_40017A函数中</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507194846086.png" alt="image-20230507194846086"></p>
<p>很乱，不知所云，继续看到sub_402B44函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507200625833.png" alt="image-20230507200625833"></p>
<p>根据函数内容恢复了两个可能的函数名，后续进入到一个类似于解压缩功能的函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092036906.png" alt="image-20230507202024683"></p>
<p>函数非常大，有一千多行，其中有一些关键的字符串帮助我们确定函数的功能是用来解压缩的，如下所示</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230507202214006.png" alt="image-20230507202214006"></p>
<p>后面的sub_4009A0函数意义不明，猜测用于解压缩后的收尾工作，回溯到上一层函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508184516134.png" alt="image-20230508184516134"></p>
<p>看到这，0xF12E6000并不在我们定义的地址范围内，flash的加载地址为0xF0000000，我们看到固件中偏移为0x2E6000处正好是一段数据的起始部分</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508192055595.png" alt="image-20230508192055595"></p>
<p>猜测flash的数据并不止被映射到了0xf0000000-0xf1000000的地址范围，从0xf1000000-0xf2000000处同样被映射为了flash的数据</p>
<p>所以再创建一个段用于存放flash的副本。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508185544916.png" alt="image-20230508185544916"></p>
<p>这里这个for循环的v1实际上计算出来为4，循环四次，下面进入解压缩的代码有一个if判断，i为0的时候，也就是循环的第一次实际上是不进入到解压缩的函数的</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508185822676.png" alt="image-20230508185822676"></p>
<p>compressed_data是被压缩的数据，从i&#x3D;0之后，compressed_data被赋值为v15的值，而v15如下</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508185935301.png" alt="image-20230508185935301"></p>
<p>正是flash中偏移为0x2E6000处开始的数据</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508190124066.png" alt="image-20230508190124066"></p>
<p>for循环中用于解压缩的函数由于i&#x3D;0时不执行，所以实际上只执行了3次，每次解压缩0x10000的数据</p>
<p>for循环结束之后</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092036338.png" alt="image-20230508190426162"></p>
<p>当i&#x3D;4时，有下面的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(v0 &amp; <span class="number">0xFFFFF</span>) != <span class="number">0</span> ? (compress_length = v0 &amp; <span class="number">0xFFFFF</span>) : (compress_length = <span class="number">0x100000</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508190539253.png" alt="image-20230508190539253"></p>
<p>v0为0x319140，所以compress_length会被更新为(compress_length &#x3D; v0 &amp; 0xFFFFF)&#x3D;0x19140</p>
<p>也就是说前三次解压缩一共解压缩了0x300000的数据，最后一次把剩下的0x19140的数据解压缩，总共要解压缩的数据长度为0x319140</p>
<p>那么这个用的是什么压缩算法，binwalk看一看</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508191329846.png" alt="image-20230508191329846"></p>
<p>识别出来的是zlib，并且很巧，识别出来的第一个zilb压缩数据正好是在0x2E6004处，也就是在0x2E6000+4处。第二个zlib压缩包位于0x375C9C处，我们到0x2E6000处看看这四个字节</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508192201659.png" alt="image-20230508192201659"></p>
<p>0x8fc93，zlib的起始位置为0x2E6004，0x2E6004+0x8fc93&#x3D;375C97，而第二块zlib数据的起始位置为0x375C9C，0x375C9C-4&#x3D;0x375C98，在循环解压缩的函数中</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508193207842.png" alt="image-20230508193207842"></p>
<p>这里有一个4字节对齐的操作，因此每一个zlib压缩数据前面的4字节实际上就是压缩数据的大小，zlib数据位置加上这个size后4字节对齐就能够得到下一个zlib数据的起始位置，其格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[size_of_compressed_data][compressed_data]</span><br></pre></td></tr></table></figure>

<p>到这里就理清楚了解压缩的思路，写一个脚本手动对其中的数据进行解压缩</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Firmware</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.frimware=<span class="built_in">open</span>(<span class="string">&quot;./ts3480.BIN&quot;</span>,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">        self.compressed_start=<span class="number">0x2E6000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress_next</span>(<span class="params">self</span>):</span><br><span class="line">        length=struct.unpack(<span class="string">&quot;&lt;I&quot;</span>,self.frimware[self.compressed_start:][:<span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        compressed_data=self.frimware[self.compressed_start+<span class="number">4</span>:][:length]</span><br><span class="line">        decompressed_data=zlib.decompress(compressed_data)</span><br><span class="line">        self.compressed_start=self.compressed_start+<span class="number">4</span>+length</span><br><span class="line">        <span class="keyword">if</span> self.compressed_start%<span class="number">4</span>!=<span class="number">0</span>:</span><br><span class="line">            self.compressed_start=self.compressed_start+(<span class="number">4</span>-(self.compressed_start%<span class="number">4</span>))</span><br><span class="line">        <span class="keyword">return</span> decompressed_data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompress</span>(<span class="params">self</span>):</span><br><span class="line">        decompressed=<span class="built_in">bytes</span>()</span><br><span class="line">        decompressed+=self.decompress_next()</span><br><span class="line">        decompressed+=self.decompress_next()</span><br><span class="line">        decompressed+=self.decompress_next()</span><br><span class="line">        decompressed+=self.decompress_next()</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">len</span>(decompressed))</span><br><span class="line">        <span class="keyword">return</span> decompressed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">firmware=Firmware()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;decompressed_data.bin&quot;</span>,<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> fd:</span><br><span class="line">    fd.write(firmware.decompress())</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看一下其中的字符串</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508194040395.png" alt="image-20230508194040395"></p>
<p>证明我们解压缩的没错。</p>
<p>那么这里解压缩的是什么呢，在一开始0x2e0000处执行的代码实际上就是bootloader，按照嵌入式设备一般的执行流程，bootloader会加载kernel，kernel再加载文件系统，所以这里解压缩的实际上是kernel。</p>
<p>kernel会被加载到哪去？</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508195756089.png" alt="image-20230508195756089"></p>
<p>在解压缩函数中，第一个参数就是数据会被解压缩到哪个地址</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508200103798.png" alt="image-20230508200103798"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((i - 1) &lt;&lt; 20)=0xi0000</span><br></pre></td></tr></table></figure>

<p>所以内核会从内存的0地址处开始加载</p>
<p>新建一个段，起始地址为0，然后将解压出来的kernel附加上去。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214455066.png" alt="image-20230508214455066"></p>
<p>在执行完解压缩功能后，bootloader会跳转到内核去</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092037416.png" alt="image-20230508214526830"></p>
<p>内核设置好各种系统参数和模式，然后跳转执行另外的代码</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214632407.png" alt="image-20230508214632407"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214641899.png" alt="image-20230508214641899"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214655516.png" alt="image-20230508214655516"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214710465.png" alt="image-20230508214710465"></p>
<p>看看sub_F02E0484函数做了什么</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214740285.png" alt="image-20230508214740285"></p>
<p>问问万能的gpt</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508214803303.png" alt="image-20230508214803303"></p>
<p>也就是说这个函数执行的也是解压缩功能，将a1处的数据解压缩到a2处，a3是解压缩的长度</p>
<p>好在IDA给出的这个函数的伪代码非常贴近于真实代码，扒下来稍微修改一下就能跑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> * <span class="title function_">decompress</span><span class="params">(<span class="type">char</span> *result, <span class="type">char</span>*a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *v3; <span class="comment">// r2</span></span><br><span class="line">    <span class="type">int</span> v4;    <span class="comment">// r3</span></span><br><span class="line">    <span class="type">int</span> v5;    <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> v6;    <span class="comment">// r4</span></span><br><span class="line">    <span class="type">int</span> v7;    <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> v8;    <span class="comment">// r5</span></span><br><span class="line">    <span class="type">int</span> v9;    <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> i;     <span class="comment">// r4</span></span><br><span class="line">    <span class="type">char</span> v11;  <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> v12;   <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> v13;   <span class="comment">// r5</span></span><br><span class="line">    <span class="type">char</span> *j;   <span class="comment">// r4</span></span><br><span class="line">    <span class="type">char</span> v15;  <span class="comment">// t1</span></span><br><span class="line"></span><br><span class="line">    v3 = &amp;a2[a3];</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        v5 = (<span class="type">uint8_t</span>)*result++;</span><br><span class="line">        v4 = v5;</span><br><span class="line">        v6 = v5 &amp; <span class="number">7</span>;</span><br><span class="line">        <span class="keyword">if</span> ((v5 &amp; <span class="number">7</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            v7 = (<span class="type">uint8_t</span>)*result++;</span><br><span class="line">            v6 = v7;</span><br><span class="line">        &#125;</span><br><span class="line">        v8 = v4 &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(v4 &gt;&gt; <span class="number">4</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            v9 = (<span class="type">uint8_t</span>)*result++;</span><br><span class="line">            v8 = v9;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (i = v6 - <span class="number">1</span>; i; ++a2)</span><br><span class="line">        &#123;</span><br><span class="line">            v11 = *result++;</span><br><span class="line">            --i;</span><br><span class="line">            *a2 = v11;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((v4 &amp; <span class="number">8</span>) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            v12 = (<span class="type">uint8_t</span>)*result++;</span><br><span class="line">            v13 = v8 + <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">for</span> (j = &amp;a2[-v12]; --v13 &gt;= <span class="number">0</span>; ++j)</span><br><span class="line">            &#123;</span><br><span class="line">                v15 = *j;</span><br><span class="line">                *a2++ = v15;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (--v8 &gt;= <span class="number">0</span>)</span><br><span class="line">                *a2++ = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (a2 &lt; v3);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp=fopen(<span class="string">&quot;./ts3480.BIN&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(fp==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fopen error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(fp,<span class="number">0x5380F0</span>,SEEK_SET);</span><br><span class="line">    <span class="type">char</span> *compressdata=(<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x3ba0</span>);</span><br><span class="line">    fread(compressdata,<span class="number">1</span>,<span class="number">0x3ba0</span>,fp);</span><br><span class="line">    <span class="type">char</span> *des=(<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x3ba0</span>);</span><br><span class="line">    <span class="keyword">if</span>(des==<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;malloc error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    decompress(compressdata,des,<span class="number">0x3BA0</span>);</span><br><span class="line">    FILE* out=fopen(<span class="string">&quot;out.bin&quot;</span>,<span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    fwrite(des,<span class="number">1</span>,<span class="number">0x3ba0</span>,out);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    fclose(out);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过这一段解压缩的数据太小，不像是文件系统，加载到IDA中看看</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508215259729.png" alt="image-20230508215259729"></p>
<p>这段数据将会被加载到0x207AE000处，所以我们在这里新建一个段再加载</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230508215935336.png" alt="image-20230508215935336"></p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092037982.png" alt="image-20230508220011829"></p>
<p>感觉是各种各样的指针。。没啥有意义的代码</p>
<p>后面的内核操作也没找到什么突破口，分析一时间陷入僵局</p>
<p>回头看看binwalk的结果</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510132611944.png" alt="image-20230510132611944"></p>
<p>固件中有三个高熵值的区域，在一开始我们解压缩了kernel，起始位置是0x2E6000&#x3D;3039232。结束位置是0x4ACFF1&#x3D;4902897</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510132851909.png" alt="image-20230510132851909"><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510132951660.png" alt="image-20230510132951660"></p>
<p>而第一个高熵值区域的起始位置恰好位于3000000处，结束位置也在1900000左右，所以可以认为第一个区域就是内核段。</p>
<p>既然这样，第二个区域和第三个区域又是什么，这两个会在什么时候进行解压缩？</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092037044.png" alt="image-20230510133816096"></p>
<p>第二个区域从0x560004开始，实际上根据我们的分析，应该是从0x560000开始的，前四字节用于存储压缩数据的长度</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510134024487.png" alt="image-20230510134024487"></p>
<p>用010跳转到0x560000可以看到前面都是用0xff来隔开的。</p>
<p>于是尝试搜索在flash中搜索0x560000，还真搜到了一个和前面解压内核类似的函数</p>
<img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510134826947.png" alt="image-20230510134826947" style="zoom:80%;" />

<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092038036.png" alt="image-20230510134859191"></p>
<p>有了前面的分析，我们可以确定这个函数实际上就是将flash中从偏移为0x560000开始、长度为0x952E9C-0x40000的数据进行解压缩</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092038254.png" alt="image-20230510135350575"></p>
<p>将其解压缩到0x40000处。</p>
<p>再搜索一下0xBA0000，同样也能搜到一个解压缩函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092038392.png" alt="image-20230510140231582"></p>
<p>将flash中从偏移为BA0000开始、长度为0x129DF94-0xD40000的数据进行解压缩，解压地址为0xD40000</p>
<p>从binwalk的分析来看依然是zlib的压缩方式，所以还是按照前面的解压缩脚本进行解压缩即可</p>
<p>看看0x560000区域的数据解压出来的字符串</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510141019058.png" alt="image-20230510141019058"></p>
<p>看起来很不错，应该这里就是业务代码了。再看看0xBA0000偏移的</p>
<img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510141258268.png" alt="image-20230510141258268" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230510141316254.png" alt="image-20230510141316254" style="zoom:50%;" />

<p>emmmmm，看起来这些才是内核代码，或者是操作系统的代码，不管了先。</p>
<p>用IDA打开业务代码，加载地址设置为0x40000</p>
<p>有一说一，IDA恢复固件是真的差，只有一小部分被解析了</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092038030.png" alt="image-20230520141948892"></p>
<p>所以还是得先用ghidra来解析</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520142112378.png" alt="image-20230520142112378"></p>
<p>ghidra基本上把整个固件都理了一遍，然后就可以在ghidra中查找感兴趣的函数，再到IDA中进行分析</p>
<p>佳能的固件中有不少的调试信息</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520142412909.png" alt="image-20230520142412909"></p>
<p>类似于[subsys:funcname],可以根据先这些调试信息来恢复一些函数名。</p>
<p>接下来开始找服务，一开始用nmap扫出来了不少服务，我选择从llmnr这个服务入手。</p>
<p>找服务的一个快捷方式就是直接搜索字符串，然后交叉引用到对应函数，在ghidra中可以找到这些字符串</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/202403092038844.png" alt="image-20230520143307040"></p>
<p>假设llmnr服务存在问题，那么问题一般存在于接收数据然后处理数据的过程中，网络接收函数一般为recv、recvmsg等等，再结合LLMNRResponder.cpp一起定位，最终交叉引用到了这个函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520143750984.png" alt="image-20230520143750984"></p>
<p>在select之前经过分析之后是LLMNRSender.cpp对应的处理函数，也就是发送响应包。</p>
<p>看到sub_26D494函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520144030968.png" alt="image-20230520144030968"></p>
<p>有两个if判断，都是以v4为基准进行判断的，而v4来源于0x21DEE2D4，这个地址我猜测用于存储一些配置信息，两个if分别判断select到的地址是ipv4还是ipv6。</p>
<p>最大能够接收1500字节的数据，然后我们看到validate_llmnr_packet函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520150002785.png" alt="image-20230520150002785"></p>
<p>我这里创建了一个llmnr协议的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LLMNR标头</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">llmnr_header</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> id;       <span class="comment">// 事务ID</span></span><br><span class="line">    <span class="type">uint16_t</span> flags;    <span class="comment">// 标志</span></span><br><span class="line">    <span class="type">uint16_t</span> qdcount;  <span class="comment">// 问题计数</span></span><br><span class="line">    <span class="type">uint16_t</span> ancount;  <span class="comment">// 回答计数</span></span><br><span class="line">    <span class="type">uint16_t</span> nscount;  <span class="comment">// 授权计数</span></span><br><span class="line">    <span class="type">uint16_t</span> arcount;  <span class="comment">// 附加计数</span></span><br><span class="line">&#125; <span class="type">llmnr_header_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LLMNR查询记录</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">llmnr_query</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span>  *qname;   <span class="comment">// 主机名</span></span><br><span class="line">    <span class="type">uint16_t</span> qtype;    <span class="comment">// 查询类型</span></span><br><span class="line">    <span class="type">uint16_t</span> qclass;   <span class="comment">// 查询类</span></span><br><span class="line">&#125; <span class="type">llmnr_query_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LLMNR请求数据包</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">llmnr_request_packet</span> &#123;</span></span><br><span class="line">    <span class="type">llmnr_header_t</span> header;     <span class="comment">// LLMNR标头</span></span><br><span class="line">    <span class="type">llmnr_query_t</span>  query;      <span class="comment">// LLMNR查询记录</span></span><br><span class="line">&#125; <span class="type">llmnr_request_packet_t</span>;</span><br></pre></td></tr></table></figure>

<p>这里就是对llmnr请求包的数据做一个判断，</p>
<p>其中llmnr请求中的qname字段最长只能为255字节，并且不能为空字节。</p>
<p>查询类型要为1，12，28，255其中一种，否则返回-1.</p>
<p>如果查询类型不为-1，就调用sub_26CE08函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520150555754.png" alt="image-20230520150555754"></p>
<p>这里应该就是根据请求包构造出响应包，然后发送给对应主机。</p>
<p>看到llmnr_generate_response_packet函数</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520152540427.png" alt="image-20230520152540427"></p>
<p>这里就是根据请求包构造响应包</p>
<p>假设有一个请求包如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+</span><br><span class="line">|       0x1234          |  // 事务ID</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0000          |  // 标志</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0001          |  // 问题计数</span><br><span class="line">+-----------------------+</span><br><span class="line">|      &quot;example&quot;        |  // 主机名</span><br><span class="line">+-----------------------+</span><br><span class="line">|     0x0001(1)         |  // 查询类型：IPv4地址</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0001         |  // 查询类：Internet</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<p>那么其对应的响应包如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------+</span><br><span class="line">|       0x1234          |  // 事务ID（与请求包相同）</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x8400          |  // 标志：响应、不可重复、无差错</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0001          |  // 问题计数</span><br><span class="line">+-----------------------+</span><br><span class="line">|      &quot;example&quot;        |  // 主机名（与请求包相同）</span><br><span class="line">+-----------------------+</span><br><span class="line">|     0x0001(1)         |  // 查询类型：IPv4地址（与请求包相同）</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0001         |  // 查询类：Internet（与请求包相同）</span><br><span class="line">+-----------------------+</span><br><span class="line">|       0x0000         |  // 资源记录数：0</span><br><span class="line">+-----------------------+</span><br><span class="line">|      0x0000          |  // 授权记录数：0</span><br><span class="line">+-----------------------+</span><br><span class="line">|      0x0001          |  // 附加记录数：1</span><br><span class="line">+-----------------------+</span><br><span class="line">|   TTL (生存时间)      |</span><br><span class="line">+-----------------------+</span><br><span class="line">|     0x0004(4)         |  // 数据长度：4字节</span><br><span class="line">+-----------------------+</span><br><span class="line">|      IP地址           |  // 回答：主机名“example”的IPv4地址</span><br><span class="line">+-----------------------+</span><br></pre></td></tr></table></figure>

<p>也就是说，请求包的请求头会原封不动的装入响应包中，包括请求查询的域名</p>
<p>calc_byte_array_length这个函数如下</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520151712049.png" alt="image-20230520151712049"></p>
<p>就是遍历给定的数组，一直找到空字符，也就是字符串的结尾，然后返回字符串的长度。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520152801660.png" alt="image-20230520152801660"></p>
<p>后面使用strncpy将请求包的query字段拷贝到响应包的字段中，拷贝长度为calc_byte_array_length计算出来的长度。</p>
<p>在这里的拷贝可能存在栈溢出的问题，由于calc_byte_array_length是根据空字符来判断字符串结尾的，所以字符串可以很长。</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230520153837689.png" alt="image-20230520153837689"></p>
<p>而response_packet的缓冲区只有0x20c的长度，但是query_packet最长可以有1500字节，因此只需要根据validate_llmnr_packet中的要求设置好llmnr请求包的请求字段数据。</p>
<p>然而在validate_llmnr_packet函数中</p>
<p><img src="https://raw.githubusercontent.com/LindLL/blog-img/main/image-20230522112617962.png" alt="image-20230522112617962"></p>
<p>由于查询类型占用两字节，而查询类型又必须为1、12、28、255中的一种，所以这两字节中有一字节肯定为0，但是这样的话</p>
<p>在后面的calc_byte_array_length函数中，碰到0就会停下来，所以实际上后续的栈溢出是无法实现的，在类型这里就会被卡住。</p>
<p>非常可惜。</p>

  </div>
  <!--文末结束语-->
  
    <div style="text-align:center;color: #ccc;font-size:24px;"> --- 本文结束 <i class="iconfont icon-heartbeat" style="font-size:24px;"></i> The End --- </div>
  
  <!--页脚广告-->
  
  <div class="mdui-divider"></div>
  
  <nav>
    
      <a rel="prev" class="post-nav-item mdui-float-left" href="/2024/01/09/%E6%9F%90%E4%BA%91%E7%9B%98%E5%88%86%E6%9E%90/">
        <i class="iconfont icon-angle-left"></i>
        <span>某云盘分析</span>
      </a>
    
    
      <a rel="next" class="post-nav-item mdui-float-right" href="/2023/09/14/musl-pwn/">
        <span>musl pwn</span>
        <i class="iconfont icon-angle-right"></i>
      </a>
    
  </nav>
</article>




  <div class="toc-button"  style="z-index: 100;">
    <button class="mdui-fab mdui-ripple mdui-color-teal" mdui-menu="{target: '#toc'}"><i class="iconfont icon-list"></i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item">
        <a href="/2024/01/09/TS3480%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/" id="toc-header" class="mdui-ripple">Table of Contents</a>
        
      </li>
    </ul>
  </div>



    <div id="comment" class="mdui-card mdui-p-a-2 mdui-m-b-5">
      <div class="mdui-tab" mdui-tab>
        
          <a href="#comment-tab0" class="mdui-ripple">gitalk</a>
        
          <a href="#comment-tab1" class="mdui-ripple">livere</a>
        
      </div>
      
        <div id="comment-tab0" class="mdui-p-a-2">
          <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id:  md5(location.pathname) ,
    distractionFreeMode: 'true',
  });
  gitalk.render('gitalk-container');
</script>
        </div>
      
        <div id="comment-tab1" class="mdui-p-a-2">
          <div id="lv-container" data-id="city" data-uid="">
  <script type="text/javascript">
    (function (d, s) {
      var j, e = d.getElementsByTagName(s)[0];
      if (typeof LivereTower === 'function') { return; }
      j = d.createElement(s);
      j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
      j.async = true;
      e.parentNode.insertBefore(j, e);
    })(document, 'script');
  </script>
  <noscript>Please enable JavaScript to view the comments powered by LiveRe.</noscript>
</div>
        </div>
      
    </div>

  </main>
  <footer id="footer" class="mdui-text-center mdui-m-t-5 mdui-p-b-2 mdui-p-t-4 mdui-color-theme">
  <div class="mdui-container">
    <div class="mdui-row">
      
        <a href="https://beian.miit.gov.cn" rel="noopener" target="_blank"></a>
      
      <span>
        &copy; 2015 - 2024 
        
          <span style="color:#d9333f" class="iconfont icon-heart"></span>
        
        John Doe
      </span>
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span>Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span>Theme: <a href="https://github.com/kb1000fx/Meadow" rel="noopener" target="_blank">Meadow</a></span>
        </div>
      
    </div>
    <div class="mdui-row">
      
        <div class="mdui-col-xs-6 mdui-text-right">
          <span id="busuanzi_container_site_uv" style="display: none;"> <span class="iconfont icon-user"></span>Total Visitors <span id="busuanzi_value_site_uv"></span></span>
        </div>
        <div class="mdui-col-xs-6 mdui-text-left">
          <span id="busuanzi_container_site_pv" style="display: none;"> <span class="iconfont icon-eye"></span>Total Views <span id="busuanzi_value_site_pv"></span></span>
        </div>
      
    </div>
 </div>
</footer>
  
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-teal" style="z-index:100;"><i class="iconfont icon-arrowup"></i></button>
  
  

    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>




    
<script src="/js/mdui.min.v1.0.0.js"></script>




<script src="/js/meadow.js"></script>

</body>
</html >